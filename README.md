
# **TELEGRAM BOT**

### **Структура**

![](https://habrastorage.org/webt/_x/wi/9y/_xwi9ygnvqhxe9x3d_vwrbelp5o.png)

**Talker**

Talker - класс, отвечающий за определенную тему. В процессе разговора с пользователем, определяется интенция и вызывается talker с соответствующей темой. 
Далее, talker пытается вычленить сущности из сообщений пользователя и сформировать ответ. В зависимости от того, удалось ли talker’у заполнить все необходимые сущности (например, время и место), происходит обращение к API (например, прогноз погоды) и формируется ответ пользователю, или же формируется запрос недостающей информации. В бота можно добавлять новых talker’ов c новыми темами или функциями и делать его более разнообразным.

**Buffer**

После вычленения интенции из сообщения пользователя в буфер добавляются talker’ы с соответствующими темами или вызываются из буфера уже существующие, но незаполненные. Они находятся в буфере до тех пор, пока не получат от пользователя все необходимые сущности и не сформируют окончательный ответ. Buffer позволяет боту понимать сообщение с несколькими интенциями и раздельно их обрабатывать.

**Natasha**

Интенции и сущности детектируются с использованием [natasha](https://github.com/natasha/natasha)

### **Функции**

**Погода**

Для детектирования данной интенции производится поиск ключевых слов, после чего производится вычленение города, количество времени и в чем оно измеряется (например 3 дня, 8 часов) или даты (23.06.2021). Далее определяются координаты города и вызывается один из следующих режимов: 

- погода на неделю вперед / кратко, 7 дней
- погода на определенный день (не далее 7 дней) / подробно, 1 день
- погода на несколько часов вперед (не далее 12 часов) / подробно, каждый час

**Расстояние между городами**

Для детектирования данной интенции производится поиск ключевых слов, после чего производится вычленение двух городов. Затем оба полученных города передаются в функцию, которая определяет их координаты, которые затем передаются в другую функцию, которая уже определяет расстояние между этими городами.

**Анекдот**

Для детектирования данной интенции производится поиск ключевых слов, после чего либо возвращается анекдот из кэша, либо (в случае, когда кэш пуст) бот стучится на сайт анекдотов, берет сразу пачку и кладет их в кэш.

### **Стили**

Перед запуском бота случайным образом выбирается один из стилей, в котором бот общается с пользователем. Стиль отражается на:

- приветствии
- прощании
- презентации
- определении неподдерживаемой интенции

При этом для каждой из этих четырех ситуации в качестве ответа доступно сразу несколько фраз. Какая из них будет выдана - тоже определяется случайно.
Доступные стили:

- дружелюбный подросток
- сталкер-стайл
- холоп

### **Screenshots**

- to add
